---
title: "Math skills and microstructure of the middle longitudinal fasciculus: A developmental investigation. Statistical analysis."
author: "Irina Buianova, Asya Istomina"
date: "January 2025"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(psych)
library(ggplot2)
library(tidyr)
library(car)
library(tidyr)
library(dplyr)
library(corrplot)
library(patchwork)
library(gridExtra)
library(Hmisc)
library(lm.beta)
library(readr)
library(dplyr)
library(stats)
library(writexl)
```

Load the data
```{r}
data <- read.csv("/Users/irina/Downloads/MathDTI/DTIMathData.csv")
data <- data[, c("FA_lh_mlf", "FA_rh_mlf", "MD_lh_mlf", "MD_rh_mlf",
                 "RD_lh_mlf", "RD_rh_mlf", "AD_lh_mlf", "AD_rh_mlf",
                 "age","age123",
                 "ADD1", "ADD2", "ADD3", "SUB1", "SUB2", "SUB3",
                 "MUL1", "MUL2", "MUL3", "DIV1", "DIV2", "DIV3",
                 "RT_ADD1", "RT_ADD2", "RT_ADD3",
                 "RT_SUB1" , "RT_SUB2" , "RT_SUB3",
                 "RT_MUL1" , "RT_MUL2", "RT_MUL3",
                 "RT_DIV1", "RT_DIV2", "RT_DIV3")]
describeBy(data, group='age123')
```

# PMT performance and age
Scatterplot: PMT ACC vs age
```{r}
# Define the predictor variables and their new names
dependent_vars <- c("ADD1", "ADD2", "ADD3", "SUB1", "SUB2", "SUB3", "MUL1", "MUL2", "MUL3", "DIV1", "DIV2", "DIV3")

new_names <- c("Addition Level 1", "Addition Level 2", "Addition Level 3", "Subtraction Level 1", "Subtraction Level 2", "Subtraction Level 3", "Multiplication Level 1", "Multiplication Level 2", "Multiplication Level 3", "Division Level 1", "Division Level 2", "Division Level 3")

# Define colors for each metric
colors <- c("ADD" = "#1f77b4", "SUB" = "#ff7f0e", "MUL" = "#2ca02c", "DIV" = "#d62728")

# Create a list to store plots
plots <- list()

# Create scatterplots with regression lines
for (i in seq_along(dependent_vars)) {
  metric <- substr(dependent_vars[i], 1, 3) # Extract the first three characters of the string stored in dependent_vars
  color <- colors[metric]
  corr <- cor(data[[dependent_vars[i]]], data$age, use = "complete.obs")
  p_value <- cor.test(data[[dependent_vars[i]]], data$age)$p.value
  
  p <- ggplot(data, aes_string(x = "age", y = dependent_vars[i])) +
    geom_point(color = alpha(color, 0.5), size = 2) +  
    geom_smooth(method = "lm", color = "darkred", size = 0.3, se = FALSE) +
    labs(x = "Age", y = new_names[i]) +
    annotate("text", x = Inf, y = Inf, label = paste0("italic(r) == ", round(corr, 2), " * ',' ~ italic(p) == ",
    format(p_value, digits = 2, scientific = TRUE)), parse = TRUE, hjust = 1.0, vjust = 3) +
    scale_x_continuous(breaks = seq(min(data$age), max(data$age), by = 2)) +
    scale_y_continuous(breaks = seq(0, 1.0, by = 0.2)) +  # Set y-axis limits and step size
    coord_cartesian(ylim = c(0, 1.0)) + 
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5), panel.grid = element_blank()) +
    theme(axis.line = element_line(color = "black", size = 0.1))
  plots[[i]] <- p
}

# Combine all plots into a single figure
scatterplot_math_age_acc <- wrap_plots(plots, ncol = 3) +
  plot_annotation(title = "Relationships between PMT Accuracy and Age") &
  theme(plot.title = element_text(hjust = 0.5, vjust=1))
#ggsave("scatterplot_math_age_acc.png", scatterplot_math_age_acc, width = 10, height = 8)

# Print the combined plot
print(scatterplot_math_age_acc)
```

Scatterplot: PMT RT vs age
```{r}
# Define the predictor variables and their new names
dependent_vars <- c("RT_ADD1", "RT_ADD2", "RT_ADD3", "RT_SUB1", "RT_SUB2", "RT_SUB3", "RT_MUL1", "RT_MUL2", "RT_MUL3", "RT_DIV1", "RT_DIV2", "RT_DIV3")

new_names <- c("Addition Level 1", "Addition Level 2", "Addition Level 3", "Subtraction Level 1", "Subtraction Level 2", "Subtraction Level 3", "Multiplication Level 1", "Multiplication Level 2", "Multiplication Level 3", "Division Level 1", "Division Level 2", "Division Level 3")

# Define colors for each metric
colors <- c("RT_AD" = "#1f77b4", "RT_SU" = "#ff7f0e", "RT_MU" = "#2ca02c", "RT_DI" = "#d62728")

# Create a list to store plots
plots <- list()

# Create scatterplots with regression lines
for (i in seq_along(dependent_vars)) {
  metric <- substr(dependent_vars[i], 1, 5) # Extract the first three characters of the string stored in dependent_vars
  color <- colors[metric]
  corr <- cor(data[[dependent_vars[i]]], data$age, use = "complete.obs")
  p_value <- cor.test(data[[dependent_vars[i]]], data$age)$p.value
  
  p <- ggplot(data, aes_string(x = "age", y = dependent_vars[i])) +
    geom_point(color = alpha(color, 0.5), size = 2) +  
    geom_smooth(method = "lm", color = "darkred", size = 0.3, se = FALSE) +  
    labs(x = "Age", y = new_names[i]) +
    annotate("text", x = Inf, y = Inf, label = paste0("italic(r) == ", round(corr, 2), " * ',' ~ italic(p) == ",
    format(p_value, digits = 2, scientific = FALSE)), parse = TRUE, hjust = 1.0, vjust = 1) +
    scale_x_continuous(breaks = seq(min(data$age), max(data$age), by = 2)) +
    scale_y_continuous(breaks = seq(0, 25, by = 5)) +  # Set y-axis limits and step size
    coord_cartesian(ylim = c(0, 20)) + 
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5), panel.grid = element_blank()) +
    theme(axis.line = element_line(color = "black", size = 0.1))
  plots[[i]] <- p
}

# Combine all plots into a single figure
scatterplot_math_age_rt <- wrap_plots(plots, ncol = 3) +
  plot_annotation(title = "Relationship between PMT Reaction Time and Age") &
  theme(plot.title = element_text(hjust = 0.5, vjust=1))
#ggsave("scatterplot_math_age_rt.png", scatterplot_math_age_rt, width = 10, height = 10)

# Print the combined plot
print(scatterplot_math_age_rt)
```

# DTI metrics
Scatterplot: DTI vs age: 
```{r}
# Define the predictor variables and their new names
predictor_vars <- c("FA_lh_mlf", "FA_rh_mlf", "AD_lh_mlf", "AD_rh_mlf", "RD_lh_mlf", "RD_rh_mlf", "MD_lh_mlf", "MD_rh_mlf")
new_names <- c("FA left MdLF", "FA right MdLF", "AD left MdLF", "AD right MdLF", "RD left MdLF", "RD right MdLF", "MD left MdLF", "MD right MdLF")

# Create a new data frame with formatted values
formatted_data <- data
for (var in predictor_vars) {
  metric <- substr(var, 1, 2)
  
  # Adjust values for MD, RD, and AD
  if (metric %in% c("MD", "RD", "AD")) {
    formatted_data[[var]] <- data[[var]] * 1000
  }
  
  # Round values for FA
  if (metric == "FA") {
    formatted_data[[var]] <- round(data[[var]], digits = 2)
  }
}

# Define colors for each metric
colors <- c("FA" = "#b3dcff", "AD" = "#7868a2", "RD" = "#416753", "MD" = "#a0ac48")

# Create a list to store plots
plots <- list()

# Calculate y-axis limits for each pair of metrics
y_limits <- list()
for (metric in unique(substr(predictor_vars, 1, 2))) {
  relevant_vars <- predictor_vars[substr(predictor_vars, 1, 2) == metric]
  y_min <- min(sapply(relevant_vars, function(var) min(formatted_data[[var]], na.rm = TRUE)))
  y_max <- max(sapply(relevant_vars, function(var) max(formatted_data[[var]], na.rm = TRUE)))
  y_limits[[metric]] <- c(y_min, y_max)
}

# Create scatterplots with regression lines
for (i in seq_along(predictor_vars)) {
  metric <- substr(predictor_vars[i], 1, 2)
  color <- colors[metric]
  
  corr <- cor(formatted_data[[predictor_vars[i]]], formatted_data$age, use = "complete.obs")
  p_value <- cor.test(formatted_data[[predictor_vars[i]]], formatted_data$age)$p.value
  
  p <- ggplot(formatted_data, aes_string(x = "age", y = predictor_vars[i])) +
    geom_point(color = alpha(color, 0.8), size = 2, stroke = 0.9, color='black') + 
    geom_smooth(method = "lm", color = "darkred", size = 0.3, se = FALSE) + 
    labs(x = "Age", y = new_names[i]) +
    annotate("text", x = Inf, y = Inf, label = paste0("italic(r) == ", round(corr, 2), " * ',' ~ italic(p) == ", format(p_value, digits = 2, scientific = TRUE)), parse = TRUE, hjust = 1.0, vjust = 3, size = 5) +
    scale_x_continuous(breaks = seq(min(formatted_data$age), max(formatted_data$age), by = 2)) +
    coord_cartesian(ylim = y_limits[[metric]]) + 
    theme_minimal() +
    theme(
        plot.title = element_text(hjust = 0.5),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        panel.grid = element_blank(),
        axis.line = element_line(color = "black", size = 0.1))
  plots[[i]] <- p
}

# Combine all plots into a single figure
scatterplot_age_dti <- wrap_plots(plots, ncol = 2) +
  plot_annotation(title = "Relationships between DTI Metrics and Age") &
  theme(plot.title = element_text(hjust = 0.5, vjust=1, size = 16))

#ggsave("/Users/irina/Downloads/MathDTI/plots/scatterplot_age_dti.png", scatterplot_age_dti, width = 7, height = 8)

# Print the combined plot
print(scatterplot_age_dti)
```

Heatmap: Correlations between DTI metrics
```{r}
# Define the predictor variables
predictor_vars <- c("FA_lh_mlf", "FA_rh_mlf", "MD_lh_mlf", "MD_rh_mlf", "RD_lh_mlf", "RD_rh_mlf", "AD_lh_mlf", "AD_rh_mlf")

# Calculate the correlation matrix
correlation_matrix <- cor(data[predictor_vars], use = "complete.obs")
colnames(correlation_matrix) <- c("FA left", "FA right", "MD left", "MD right", "RD left", "RD right", "AD left", "AD right")
rownames(correlation_matrix) <- c("FA left", "FA right", "MD left", "MD right", "RD left", "RD right", "AD left", "AD right")

# Define a pastel color palette
pastel_colors <- colorRampPalette(c("#0571B0", "white", "#F8766D"))(200)

# Visualize the correlation matrix
print(correlation_matrix)
corrplot(correlation_matrix, method = "circle", col = pastel_colors, 
         addCoef.col = "black", tl.col = "black", tl.srt = 45, diag=FALSE)
```
```{r}
# Export p-values and Pearson r as a table
correlation_results <- rcorr(as.matrix(data[predictor_vars]), type = "pearson")
correlation_matrix <- correlation_results$r
p_values <- correlation_results$P

# Set column and row names
colnames(correlation_matrix) <- c("FA left", "FA right", "MD left", "MD right", "RD left", "RD right", "AD left", "AD right")
rownames(correlation_matrix) <- c("FA left", "FA right", "MD left", "MD right", "RD left", "RD right", "AD left", "AD right")
colnames(p_values) <- colnames(correlation_matrix)
rownames(p_values) <- rownames(correlation_matrix)

# Combine correlation coefficients and p-values into a single data frame
results_table <- data.frame(
  Variable1 = rep(rownames(correlation_matrix), times = ncol(correlation_matrix)),
  Variable2 = rep(colnames(correlation_matrix), each = nrow(correlation_matrix)),
  Correlation = as.vector(correlation_matrix),
  P_Value = as.vector(p_values))

print(results_table)
```


# Linear regression models
## *PMT performance ~ age x (DTI left MdLF + DTI right MdLF)*

Standardized model, scaled data
```{r}
# Define dependent variables
dependent_vars <- c("ADD1", "ADD2", "ADD3", "SUB1", "SUB2", "SUB3", "MUL1", "MUL2", "MUL3", "DIV1", "DIV2", "DIV3",
                    "RT_ADD1", "RT_ADD2", "RT_ADD3", "RT_SUB1", "RT_SUB2", "RT_SUB3", "RT_MUL1", "RT_MUL2",
                    "RT_MUL3", "RT_DIV1", "RT_DIV2", "RT_DIV3")

# List of predictor variable groups
predictor_vars_list <- list(
  c("FA_lh_mlf", "FA_rh_mlf"),
  c("AD_lh_mlf", "AD_rh_mlf"),
  c("RD_lh_mlf", "RD_rh_mlf"),
  c("MD_lh_mlf", "MD_rh_mlf"))

# Scale the predictor variables
scaled_data <- data
for (predictor_vars in predictor_vars_list) {
  for (var in predictor_vars) {
    scaled_data[[var]] <- scale(data[[var]])
  }
}

# Initialize lists to store the results
lm_results_list <- list()
standardized_results_list <- list()

for (predictor_vars in predictor_vars_list) {
  for (dep_var in dependent_vars) {
    lm_formula <- as.formula(paste(dep_var, "~ age * (", paste(predictor_vars, collapse = " + "), ")"))
    lm_results <- lm(lm_formula, data = scaled_data)
    model_name <- paste(dep_var, paste(predictor_vars, collapse = "_"), sep = "_")
    lm_results_list[[model_name]] <- summary(lm_results)
    
    # Get standardized coefficients
    standardized_model <- lm.beta(lm_results)
    standardized_model_name <- paste(dep_var, paste(predictor_vars, collapse = "_"), "_model_standardized", sep = "_")
    standardized_results_list[[standardized_model_name]] <- summary(standardized_model)
  }
}

# Export lm results
results_df_scaled <- data.frame()
standardized_results_df_scaled <- data.frame()

for (model_name in names(lm_results_list)) {
  summary_model <- lm_results_list[[model_name]]
  coef_df <- as.data.frame(summary_model$coefficients)
  coef_df$Model <- model_name
  results_df_scaled <- rbind(results_df_scaled, coef_df)
}

for (model_name in names(standardized_results_list)) {
  summary_model <- standardized_results_list[[model_name]]
  coef_df <- as.data.frame(summary_model$coefficients)
  coef_df$Model <- model_name
  standardized_results_df_scaled <- rbind(standardized_results_df_scaled, coef_df)
}

# Write results to CSV
#write.csv(results_df_scaled, "lm_results_original_scaled.csv", row.names = TRUE)
#write.csv(standardized_results_df_scaled, "lm_results_standardized_scaled.csv", row.names = TRUE)
#cat("Results have been exported to lm_results_original_scaled.csv and lm_results_standardized_scaled.csv\n")

# Print the summaries of all models
for (model_name in names(lm_results_list)) {
  cat("\nSummary for", model_name, ":\n")
  print(lm_results_list[[model_name]])
}

for (model_name in names(standardized_results_list)) {
  cat("\nSummary for", model_name, ":\n")
  print(standardized_results_list[[model_name]])
}
#################################################

# Export model statistics
model_stats_list_scaled <- list()

for (predictor_vars in predictor_vars_list) {
  for (dep_var in dependent_vars) {
    lm_formula <- as.formula(paste(dep_var, "~ age * (", paste(predictor_vars, collapse = " + "), ")"))
    lm_results <- lm(lm_formula, data = scaled_data)
    standardized_model <- lm.beta(lm_results)
    model_name <- paste(dep_var, paste(predictor_vars, collapse = "_"), "_model_standardized", sep = "_")
    
    # Collect model statistics
    model_stats <- data.frame(
      Model = model_name,
      R_squared = summary(standardized_model)$r.squared,
      Adjusted_R_squared = summary(standardized_model)$adj.r.squared,
      F_statistic = summary(standardized_model)$fstatistic[1],
      F_p_value = pf(summary(standardized_model)$fstatistic[1], summary(standardized_model)$fstatistic[2], summary(standardized_model)$fstatistic[3], lower.tail = FALSE)
    )
    model_stats_list_scaled[[model_name]] <- model_stats
  }
}

# Combine all model statistics into a single data frame
model_stats_df_scaled <- do.call(rbind, model_stats_list_scaled)

# Write results to CSV
#write.csv(model_stats_df_scaled, "lm_model_statistics_standardized_scaled.csv", row.names = TRUE)
#cat("Model statistics have been exported to lm_model_statistics_standardized_scaled.csv\n")
```

# Group analysis: Violin plots

Prepare data: PMT ACC
```{r}
# Pivot the dataframe for each operation
data_long_add <- data %>%
  select(age123, ADD1, ADD2, ADD3) %>%
  pivot_longer(cols = starts_with("ADD"), names_to = "Condition", values_to = "Value")

data_long_sub <- data %>%
  select(age123, SUB1, SUB2, SUB3) %>%
  pivot_longer(cols = starts_with("SUB"), names_to = "Condition", values_to = "Value")

data_long_mul <- data %>%
  select(age123, MUL1, MUL2, MUL3) %>%
  pivot_longer(cols = starts_with("MUL"), names_to = "Condition", values_to = "Value")

data_long_div <- data %>%
  select(age123, DIV1, DIV2, DIV3) %>%
  pivot_longer(cols = starts_with("DIV"), names_to = "Condition", values_to = "Value")

# Factorize the age group column for all datasets
data_long_add$age123 <- factor(data_long_add$age123, labels = c("Children", "Adolescents", "Adults"))
data_long_sub$age123 <- factor(data_long_sub$age123, labels = c("Children", "Adolescents", "Adults"))
data_long_mul$age123 <- factor(data_long_mul$age123, labels = c("Children", "Adolescents", "Adults"))
data_long_div$age123 <- factor(data_long_div$age123, labels = c("Children", "Adolescents", "Adults"))
```

Prepare data: PMT RT
```{r}
# Pivot the dataframe for each operation
data_long_add_rt <- data %>%
  select(age123, RT_ADD1, RT_ADD2, RT_ADD3) %>%
  pivot_longer(cols = starts_with("RT_ADD"), names_to = "Condition", values_to = "Value")

data_long_sub_rt <- data %>%
  select(age123, RT_SUB1, RT_SUB2, RT_SUB3) %>%
  pivot_longer(cols = starts_with("RT_SUB"), names_to = "Condition", values_to = "Value")

data_long_mul_rt <- data %>%
  select(age123, RT_MUL1, RT_MUL2, RT_MUL3) %>%
  pivot_longer(cols = starts_with("RT_MUL"), names_to = "Condition", values_to = "Value")

data_long_div_rt <- data %>%
  select(age123, RT_DIV1, RT_DIV2, RT_DIV3) %>%
  pivot_longer(cols = starts_with("RT_DIV"), names_to = "Condition", values_to = "Value")

# Factorize the age group column for all datasets
data_long_add_rt$age123 <- factor(data_long_add_rt$age123, labels = c("Children", "Adolescents", "Adults"))
data_long_sub_rt$age123 <- factor(data_long_sub_rt$age123, labels = c("Children", "Adolescents", "Adults"))
data_long_mul_rt$age123 <- factor(data_long_mul_rt$age123, labels = c("Children", "Adolescents", "Adults"))
data_long_div_rt$age123 <- factor(data_long_div_rt$age123, labels = c("Children", "Adolescents", "Adults"))
```

Prepare data: DTI
```{r}
predictor_vars <- c("FA_lh_mlf", "FA_rh_mlf", "AD_lh_mlf", "AD_rh_mlf", "RD_lh_mlf", "RD_rh_mlf", "MD_lh_mlf", "MD_rh_mlf")

# Create a formatted data frame with adjusted values for MD, RD, and AD
formatted_data <- data
for (var in predictor_vars) {
  metric <- substr(var, 1, 2)
  
  # Adjust values for MD, RD, and AD
  if (metric %in% c("MD", "RD", "AD")) {
    formatted_data[[var]] <- data[[var]] * 1000
  }
}

# Pivot the dataframe for each operation
data_long_fa <- formatted_data %>%
  select(age123, FA_lh_mlf, FA_rh_mlf) %>%
  pivot_longer(cols = starts_with("FA"), names_to = "Condition", values_to = "Value")

data_long_ad <- formatted_data %>%
  select(age123, AD_lh_mlf, AD_rh_mlf) %>%
  pivot_longer(cols = starts_with("AD"), names_to = "Condition", values_to = "Value")

data_long_rd <- formatted_data %>%
  select(age123, RD_lh_mlf, RD_rh_mlf) %>%
  pivot_longer(cols = starts_with("RD"), names_to = "Condition", values_to = "Value")

data_long_md <- formatted_data %>%
  select(age123, MD_lh_mlf, MD_rh_mlf) %>%
  pivot_longer(cols = starts_with("MD"), names_to = "Condition", values_to = "Value")

# Factorize the age group column for all datasets
data_long_fa$age123 <- factor(data_long_fa$age123, labels = c("Children", "Adolescents", "Adults"))
data_long_ad$age123 <- factor(data_long_ad$age123, labels = c("Children", "Adolescents", "Adults"))
data_long_rd$age123 <- factor(data_long_rd$age123, labels = c("Children", "Adolescents", "Adults"))
data_long_md$age123 <- factor(data_long_md$age123, labels = c("Children", "Adolescents", "Adults"))
```

Violin plot: PMT ACC
```{r}
# Violin plot for addition
violin_plot_add <- ggplot(data_long_add, aes(x = Condition, y = Value, fill = age123)) +
  geom_violin(trim = FALSE, fill = "#cc0000", color = "black", alpha = 0.4, width = 1.08, size = 0.3) +
  geom_jitter(shape = 16, color = "#000000", size = 0.3, width = 0.1) +
  facet_wrap(~ age123, scales = "free") +
  labs(x = NULL, y = NULL) +
  scale_x_discrete(labels = c("ADD1" = "ADD1", "ADD2" = "ADD2", "ADD3" = "ADD3")) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)), breaks = seq(0, 1, by = 0.2)) +
  coord_cartesian(ylim = c(-0.3, 1.3)) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.line = element_line(color = "black", size = 0.1),
        axis.text.x = element_text(angle = 0, hjust = 0.5, size = rel(2)),
        axis.text.y = element_text(size = rel(2)),
        strip.text = element_text(size = rel(2), vjust = 3, margin = margin(t = 20, b = 5)),
        panel.spacing = unit(1, "lines"),
        legend.position = "none")

# Violin plot for subtraction
violin_plot_sub <- ggplot(data_long_sub, aes(x = Condition, y = Value, fill = age123)) +
  geom_violin(trim = FALSE, fill = "#47993d", color = "black", alpha = 0.4, width = 1.08, size = 0.3) +
  geom_jitter(shape = 16, color = "#000000", size = 0.3, width = 0.1) +
  facet_wrap(~ age123, scales = "free") +
  labs(x = NULL, y = NULL) +
  scale_x_discrete(labels = c("SUB1" = "SUB1", "SUB2" = "SUB2", "SUB3" = "SUB3")) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)), breaks = seq(0, 1, by = 0.2)) +
  coord_cartesian(ylim = c(-0.3, 1.3)) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.line = element_line(color = "black", size = 0.1),
        axis.text.x = element_text(angle = 0, hjust = 0.5, size = rel(2)),
        axis.text.y = element_text(size = rel(2)),
        strip.text = element_blank(),
        panel.spacing = unit(1, "lines"),
        legend.position = "none")

# Violin plot for multiplication
violin_plot_mul <- ggplot(data_long_mul, aes(x = Condition, y = Value, fill = age123)) +
  geom_violin(trim = FALSE, fill = "#137db7", color = "black", alpha = 0.4, width = 1.08, size = 0.3) +
  geom_jitter(shape = 16, color = "#000000", size = 0.3, width = 0.1) +
  facet_wrap(~ age123, scales = "free") +
  labs(x = NULL, y = NULL) +
  scale_x_discrete(labels = c("MUL1" = "MUL1", "MUL2" = "MUL2", "MUL3" = "MUL3")) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)), breaks = seq(0, 1, by = 0.2)) +
  coord_cartesian(ylim = c(-0.3, 1.3)) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.line = element_line(color = "black", size = 0.1),
        axis.text.x = element_text(angle = 0, hjust = 0.5, size = rel(2)),
        axis.text.y = element_text(size = rel(2)),
      #  axis.title.y = element_text(size = rel(2)),
        strip.text = element_blank(),
        panel.spacing = unit(1, "lines"),
        legend.position = "none")

# Violin plot for division
violin_plot_div <- ggplot(data_long_div, aes(x = Condition, y = Value, fill = age123)) +
  geom_violin(trim = FALSE, fill = "#f3b72e", color = "black", alpha = 0.4, width = 1.08, size = 0.3) +
  geom_jitter(shape = 16, color = "#000000", size = 0.3, width = 0.1) +
  facet_wrap(~ age123, scales = "free") +
  labs(x = NULL, y = NULL) +
  scale_x_discrete(labels = c("DIV1" = "DIV1", "DIV2" = "DIV2", "DIV3" = "DIV3")) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)), breaks = seq(0, 1, by = 0.2)) +
  coord_cartesian(ylim = c(-0.3, 1.3)) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.line = element_line(color = "black", size = 0.1),
        axis.text.x = element_text(angle = 0, hjust = 0.5, size = rel(2)),
        axis.text.y = element_text(size = rel(2)),
        strip.text = element_blank(),
        panel.spacing = unit(1, "lines"),
        legend.position = "none")

# Create a blank plot with the y-axis label
y_label <- ggplot() + 
  annotate("text", x = 1, y = 1, label = "Accuracy", angle = 90, size = 10) + 
  theme_void() + 
  theme(plot.margin = margin(0, 0, 0, 0))

# Combine the blank plot with the actual plots
violin_acc <- wrap_plots(
  y_label, 
  (violin_plot_add / violin_plot_sub / violin_plot_mul / violin_plot_div) + 
    plot_layout(guides = 'collect'),
  ncol = 2,
  widths = c(0.1, 1))

#ggsave("/Users/irina/Downloads/MathDTI/plots/violin_acc.png", violin_acc, width = 12, height = 12)
print(violin_acc)
```

Violin plots: PMT RT
```{r}
# Violin plot for addition
violin_plot_add_rt <- ggplot(data_long_add_rt, aes(x = Condition, y = Value, fill = age123)) +
  geom_violin(trim = FALSE, fill = "#cc0000", color = "black", alpha = 0.4, width = 1.4, size = 0.3) +
  geom_jitter(shape = 16, color = "#000000", size = 0.3, width = 0.1) +
  facet_wrap(~ age123, scales = "free") +
  labs(x = NULL, y = NULL) +
  scale_x_discrete(labels = c("RT_ADD1" = "ADD1", "RT_ADD2" = "ADD2", "RT_ADD3" = "ADD3")) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)), breaks = seq(0, 30, by = 5)) +
  coord_cartesian(ylim = c(-3, 30)) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.line = element_line(color = "black", size = 0.1),
        axis.text.x = element_text(angle = 0, hjust = 0.5, size = rel(2)),
        axis.text.y = element_text(size = rel(2)),
        strip.text = element_text(size = rel(2), vjust = 3, margin = margin(t = 20, b = 5)),
        panel.spacing = unit(1, "lines"),
        legend.position = "none")

# Violin plot for subtraction
violin_plot_sub_rt <- ggplot(data_long_sub_rt, aes(x = Condition, y = Value, fill = age123)) +
  geom_violin(trim = FALSE, fill = "#47993d", color = "black", alpha = 0.4, width = 1.4, size = 0.3) +
  geom_jitter(shape = 16, color = "#000000", size = 0.3, width = 0.1) +
  facet_wrap(~ age123, scales = "free") +
  labs(x = NULL, y = NULL) +
  scale_x_discrete(labels = c("RT_SUB1" = "SUB1", "RT_SUB2" = "SUB2", "RT_SUB3" = "SUB3")) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)), breaks = seq(0, 30, by = 5)) +
  coord_cartesian(ylim = c(-3, 30)) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.line = element_line(color = "black", size = 0.1),
        axis.text.x = element_text(angle = 0, hjust = 0.5, size = rel(2)),
        axis.text.y = element_text(size = rel(2)),
        strip.text = element_blank(),
        panel.spacing = unit(1, "lines"),
        legend.position = "none")

# Violin plot for multiplication
violin_plot_mul_rt <- ggplot(data_long_mul_rt, aes(x = Condition, y = Value, fill = age123)) +
  geom_violin(trim = FALSE, fill = "#137db7", color = "black", alpha = 0.4, width = 1.4, size = 0.3) +
  geom_jitter(shape = 16, color = "#000000", size = 0.3, width = 0.1) +
  facet_wrap(~ age123, scales = "free") +
  labs(x = NULL, y = NULL) +
  scale_x_discrete(labels = c("RT_MUL1" = "MUL1", "RT_MUL2" = "MUL2", "RT_MUL3" = "MUL3")) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)), breaks = seq(0, 40, by = 5)) +
  coord_cartesian(ylim = c(-3, 40)) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.line = element_line(color = "black", size = 0.1),
        axis.text.x = element_text(angle = 0, hjust = 0.5, size = rel(2)),
        axis.text.y = element_text(size = rel(2)),
        strip.text = element_blank(),
        panel.spacing = unit(1, "lines"),
        legend.position = "none")

# Violin plot for division
violin_plot_div_rt <- ggplot(data_long_div_rt, aes(x = Condition, y = Value, fill = age123)) +
  geom_violin(trim = FALSE, fill = "#f3b72e", color = "black", alpha = 0.4, width = 1.4, size = 0.3) +
  geom_jitter(shape = 16, color = "#000000", size = 0.3, width = 0.1) +
  facet_wrap(~ age123, scales = "free") +
  labs(x = NULL, y = NULL) +
  scale_x_discrete(labels = c("RT_DIV1" = "DIV1", "RT_DIV2" = "DIV2", "RT_DIV3" = "DIV3")) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)), breaks = seq(0, 40, by = 5)) +
  coord_cartesian(ylim = c(-3, 40)) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.line = element_line(color = "black", size = 0.1),
        axis.text.x = element_text(angle = 0, hjust = 0.5, size = rel(2)),
        axis.text.y = element_text(size = rel(2)),
        strip.text = element_blank(),
        panel.spacing = unit(1, "lines"),
        legend.position = "none")

# Create a blank plot with the y-axis label
y_label <- ggplot() + 
  annotate("text", x = 1, y = 1, label = "Reaction Time", angle = 90, size = 10) + 
  theme_void() + 
  theme(plot.margin = margin(0, 0, 0, 0))

# Combine the blank plot with the actual plots
violin_rt <- wrap_plots(
  y_label, 
  (violin_plot_add_rt / violin_plot_sub_rt / violin_plot_mul_rt / violin_plot_div_rt) + 
    plot_layout(guides = 'collect'),
  ncol = 2,
  widths = c(0.1, 1))

#ggsave("/Users/irina/Downloads/MathDTI/plots/violin_rt.png", violin_rt, width = 12, height = 12)
print(violin_rt)
```

Violin plots: DTI
```{r}
# Violin plot for addition
violin_plot_fa <- ggplot(data_long_fa, aes(x = Condition, y = Value, fill = age123)) +
  geom_violin(trim = FALSE, fill = "#b3dcff", color = "black", alpha = 0.3, width = 1.08, size = 0.1) +
  geom_jitter(shape = 16, color = "#000000", size = 0.4, width = 0.1) +
  facet_wrap(~ age123, scales = "free") +
  labs(x = NULL, y = NULL) +
  scale_x_discrete(labels = c("FA_lh_mlf" = "FA left", "FA_rh_mlf" = "FA right")) +
  #scale_y_continuous(expand = expansion(mult = c(0, 0.05)), breaks = seq(0, 30, by = 5)) +
  coord_cartesian(ylim = c(0.20, 0.37)) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.line = element_line(color = "black", size = 0.1),
        axis.text.x = element_text(angle = 0, hjust = 0.5, size = rel(2)),
        axis.text.y = element_text(size = rel(2)),
        strip.text = element_text(size = rel(2), vjust = 3, margin = margin(t = 20, b = 5)),
        panel.spacing = unit(1, "lines"),
        legend.position = "none")

# Violin plot for subtraction
violin_plot_ad <- ggplot(data_long_ad, aes(x = Condition, y = Value, fill = age123)) +
  geom_violin(trim = FALSE, fill = "#7868a2", color = "black", alpha = 0.3, width = 1.08, size = 0.1) +
  geom_jitter(shape = 16, color = "#000000", size = 0.4, width = 0.1) +
  facet_wrap(~ age123, scales = "free") +
  labs(x = NULL, y = NULL) +
  scale_x_discrete(labels = c("AD_lh_mlf" = "AD left", "AD_rh_mlf" = "AD right")) +
  coord_cartesian(ylim = c(0.8, 1.2)) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.line = element_line(color = "black", size = 0.1),
        axis.text.x = element_text(angle = 0, hjust = 0.5, size = rel(2)),
        axis.text.y = element_text(size = rel(2)),
        strip.text = element_blank(),
        panel.spacing = unit(1, "lines"),
        legend.position = "none")

# Violin plot for multiplication
violin_plot_rd <- ggplot(data_long_rd, aes(x = Condition, y = Value, fill = age123)) +
  geom_violin(trim = FALSE, fill = "#416753", color = "black", alpha = 0.3, width = 1.08, size = 0.1) +
  geom_jitter(shape = 16, color = "#000000", size = 0.4, width = 0.1) +
  facet_wrap(~ age123, scales = "free") +
  labs(x = NULL, y = NULL) +
  scale_x_discrete(labels = c("RD_lh_mlf" = "RD left", "RD_rh_mlf" = "RD right")) +
  coord_cartesian(ylim = c(0.5, 0.75)) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.line = element_line(color = "black", size = 0.1),
        axis.text.x = element_text(angle = 0, hjust = 0.5, size = rel(2)),
        axis.text.y = element_text(size = rel(2)),
        strip.text = element_blank(),
        panel.spacing = unit(1, "lines"),
        legend.position = "none")

# Violin plot for division
violin_plot_md <- ggplot(data_long_md, aes(x = Condition, y = Value, fill = age123)) +
  geom_violin(trim = FALSE, fill = "#a0ac48", color = "black", alpha = 0.3, width = 1.08, size = 0.1) +
  geom_jitter(shape = 16, color = "#000000", size = 0.4, width = 0.1) +
  facet_wrap(~ age123, scales = "free") +
  labs(x = NULL, y = NULL) +
  scale_x_discrete(labels = c("MD_lh_mlf" = "MD left", "MD_rh_mlf" = "MD right")) +
  coord_cartesian(ylim = c(0.7, 0.9)) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.line = element_line(color = "black", size = 0.1),
        axis.text.x = element_text(angle = 0, hjust = 0.5, size = rel(2)),
        axis.text.y = element_text(size = rel(2)),
        #axis.title.y = element_text(size = rel(2)),
        strip.text = element_blank(),
        panel.spacing = unit(1, "lines"),
        legend.position = "none")

violin_dti <- (violin_plot_fa / violin_plot_ad / violin_plot_rd / violin_plot_md)

#ggsave("/Users/irina/Downloads/MathDTI/plots/violin_dti.png", violin_dti, width = 10, height = 10)
print(violin_dti)
```

# Group analysis

DTI: Compare left and right hemispheres
```{r}
# Convert age123 to a factor
data$age123 <- as.factor(data$age123)

# Specify the variables for analysis
variables <- c("FA_lh_mlf", "FA_rh_mlf", "AD_lh_mlf", "AD_rh_mlf", "RD_lh_mlf", "RD_rh_mlf", "MD_lh_mlf", "MD_rh_mlf")

# Function to perform paired t-tests for each pair of variables
perform_ttests <- function(data, group_var, variables) {
  results <- data.frame(Group = character(), Comparison = character(), t_statistic = numeric(), p_value = numeric(), stringsAsFactors = FALSE)
  
  for (i in seq(1, length(variables), by = 2)) {
    var1 <- variables[i]
    var2 <- variables[i + 1]
    
    for (group in levels(data[[group_var]])) {
      group_data <- subset(data, data[[group_var]] == group)
      if (nrow(group_data) > 1) {
        ttest <- t.test(group_data[[var1]], group_data[[var2]], paired = TRUE)
        results <- rbind(results, data.frame(Group = group, Comparison = paste(var1, "vs", var2), t_statistic = ttest$statistic, p_value = ttest$p.value))
      }
    }
  }
  
  return(results)
}

# Perform the t-tests
ttest_results <- perform_ttests(data, "age123", variables)

# Export the results to a CSV file
write.csv(ttest_results, "ttest_results.csv", row.names = FALSE)
print("The t-test results have been saved to ttest_results.csv.")
print(ttest_results)
```

Desciptive statistics
```{r}
# Convert 'age123' to a factor if not already done
data$age123 <- as.factor(data$age123)

# Specify the variables for analysis
variables <- c("FA_lh_mlf", "FA_rh_mlf", "MD_lh_mlf", "MD_rh_mlf", "RD_lh_mlf", "RD_rh_mlf",
               "AD_lh_mlf", "AD_rh_mlf", "ADD1", "ADD2", "ADD3", "SUB1", "SUB2", "SUB3",
               "MUL1", "MUL2", "MUL3", "DIV1", "DIV2", "DIV3", 
               "RT_ADD1", "RT_ADD2", "RT_ADD3", "RT_SUB1", "RT_SUB2", "RT_SUB3",
               "RT_MUL1", "RT_MUL2", "RT_MUL3", "RT_DIV1", "RT_DIV2", "RT_DIV3")

# Calculate mean and standard deviation for each variable within each age group
mean_sd_by_age <- data %>%
  group_by(age123) %>%
  summarise(across(all_of(variables), list(mean = ~mean(.x, na.rm = TRUE), sd = ~sd(.x, na.rm = TRUE)), .names = "{col}_{fn}"))

# Save the results
write.csv(mean_sd_by_age, "mean_sd_results_by_age.csv", row.names = FALSE)
write_xlsx(mean_sd_by_age, "mean_sd_results_by_age.xlsx")

print("Mean and standard deviation for each variable by age group have been saved to 'mean_sd_results_by_age.csv' and 'mean_sd_results_by_age.xlsx'.")

print(mean_sd_by_age)
```

ANOVA
```{r}
# Initialize a list to store ANOVA results
anova_results <- list()

# Loop through each variable and perform ANOVA and Tukey's HSD test
for (variable in variables) {
  # Perform ANOVA for the variable
  model <- aov(as.formula(paste(variable, "~ age123")), data = data)
  anova_result <- summary(model)
  
  # Extract p-values
  p_value <- anova_result[[1]]$`Pr(>F)`[1]
  
  # Capture & print the ANOVA summary output
  anova_output <- capture.output(print(anova_result))
  cat("\nANOVA for", variable, "\n")
  print(anova_result)
  
  # Store the ANOVA result in the list
  anova_results[[variable]] <- list(
    "ANOVA" = anova_output,
    "p_value" = p_value
  )
  
  # Check if the ANOVA result is significant (p-value less than 0.05)
  if (p_value < 0.05) {
    # Perform Tukey's HSD test
    tukey_result <- TukeyHSD(model)
    
    # Tukey's HSD test
    tukey_output <- capture.output(print(tukey_result))
    cat("\nTukey's HSD test for", variable, "\n")
    print(tukey_result)
    
    # Store the Tukey's HSD test result in the list
    anova_results[[variable]]$TukeyHSD <- tukey_output
  } else {
    cat("ANOVA result for", variable, "is not significant (p-value > 0.05). No Tukey's HSD test performed.\n")
  }
}

# Convert the list of ANOVA results to a data frame
anova_df <- do.call(rbind, lapply(names(anova_results), function(variable) {
  data.frame(
    Variable = variable,
    ANOVA = paste(anova_results[[variable]]$ANOVA, collapse = "\n"),
    p_value = anova_results[[variable]]$p_value,
    TukeyHSD = if (!is.null(anova_results[[variable]]$TukeyHSD)) paste(anova_results[[variable]]$TukeyHSD, collapse = "\n") else NA
  )
}))

write_xlsx(anova_df, "anova_results.xlsx")
```
